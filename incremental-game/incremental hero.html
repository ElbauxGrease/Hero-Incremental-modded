<body height="window.height" width="window.width">
<script>

var clickables = {}
clickables["zone1"] = { left: 10, top: 10, height: 75, width: 75, action: function() {
	currentStage = 1
	hero.x = 350
	hero.y = 600
	enemies.splice(0, enemies.length)
	spawnEnemies()
}}
showInventory = false
clickables["inventory"] = { left: 10, top: 180, height: 14, width: 100, action: function() {
	showInventory = true
}}

var species_tags = [ "kobold", "beast", "giant", "golem", "demon", "dragon" ]
var species = {
	"kobold": {
		symbol: "k",
		health: 10,
		attack: 10,
		defence: 5,
		reward: 1
	},
	"beast": {
		symbol: "b",
		health: 20,
		attack: 10,
		defence: 10,
		reward: 5
	},
	"giant": {
		symbol: "gi",
		health: 40,
		attack: 20,
		defence: 20,
		reward: 10
	},
	"golem": {
		symbol: "ho",
		health: 80,
		attack: 40,
		defence: 40,
		reward: 20
	},
	"demon": {
		symbol: "de",
		health: 160,
		attack: 80,
		defence: 80,
		reward: 40
	},
	"dragon": {
		symbol: "dr",
		health: 320,
		attack: 160,
		defence: 160,
		reward: 100
	}
}

var elements_tags = [ "crystal", "stone", "leaf" ]
var elements = {
	"crystal": {
		color: "blue",
		attack: 1.1,
		defence: 1.0,
		health: 1.0
	},
	"stone": {
		color: "brown",
		attack: 1.0,
		defence: 1.1,
		health: 1.0
	},
	"leaf": {
		color: "green",
		attack: 1.0,
		defence: 1.0,
		health: 1.1
	}
}

var drops = {
	"shortsword": {
		attack: 10,
		range: 25,
		cooldown: .5,
		type: "sword"
	},
	"longsword": {
		attack: 20,
		range: 30,
		cooldown: .5,
		type: "sword"
	},
	"greatsword": {
		attack: 40,
		range: 35,
		cooldown: .5,
		type: "sword"
	},
	"shortbow": {
		attack: 2,
		range: 100,
		cooldown: .5,
		type: "bow"
	},
	"longbow": {
		attack: 25,
		range: 125,
		cooldown: 1,
		type: "bow"
	},
	"greatbow": {
		attack: 100,
		range: 175,
		cooldown: 1.5,
		type: "bow"
	},
	"staff": {
		attack: 25,
		range: 50,
		cooldown: 1,
		type: "magic"
	},
	"battlestaff": {
		attack: 100,
		range: 75,
		cooldown: 1,
		type: "magic"
	},
	"tome": {
		attack: 100,
		range: 75,
		cooldown: .5,
		type: "magic"
	},
	"leather helm": {
		defence: 2,
		type: "helmet"
	},
	"med helm": {
		defence: 4,
		type: "helmet"
	},
	"full helm": {
		defence: 6,
		type: "helmet"
	},
	"leather torso": {
		defence: 2,
		type: "torso"
	},
	"chain torso": {
		defence: 4,
		type: "torso"
	},
	"platebody": {
		defence: 6,
		type: "torso"
	},
	"leather chaps": {
		defence: 2,
		type: "legs"
	},
	"chainskirt": {
		defence: 4,
		type: "legs"
	},
	"platelegs": {
		defence: 6,
		type: "legs"
	}
}

var attributes = {
	" of spite": {
		attack: 2
	},
	" of rage": {
		attack: 4
	},
	" of fury": {
		attack: 6
	},
	" of will": {
		defence: 2
	},
	" of protection": {
		defence: 4
	},
	" of resistance": {
		defence: 6
	}
}

var bolt = {
	x: undefined,
	y: undefined,
	targetid: undefined,
	angle: 0
}

var hero = {
	x: 350,
	y: 600,
	health: 100,
	attack: 100,
	defence: 10,
	speed: 5,
	cooldown: Date.now()/1000,
	weapon: { cooldown: 1, range: 25, attack: 0, type: "sword" },
	helmet: "",
	torso: "",
	legs: ""
}

var enemies = []
var inventory = {}
var inventory_loaded = false
var messages = []
var clear_messages = Date.now()/1000
var boltFired = false

var currentZone = 1
var highestZone = 1
var currentStage = 1
var crystal_store = 0
var stone_store = 0
var leaf_store = 0

var then = Date.now(),
	start

function spawnEnemies() {
	for(i=0; i<currentStage; i++){
		enemies.push({
			species: species_tags[currentZone-1],
			element: elements_tags[Math.floor(3*Math.random())],
			x: 100 + 500*Math.random(),
			y: 100 + 200*Math.random(),
			trajectory: {
				angle: 2*Math.PI*Math.random(),
				turning: 0
			},
			cooldown: Date.now()/1000,
			aggro: false,
			health: species[species_tags[currentZone-1]].health
		})
	}
}

var main = function() {
	function createCanvas() {
		function drawHero(hero) {
			ctx.save()

			ctx.fillStyle = "red"
			ctx.font = "16px Arial"
			ctx.fillText("H", hero.x, hero.y)

			ctx.restore()
		}
		function drawEnemy(object) {
			ctx.save()

			enemy_element = object["element"]
			enemy_species = object["species"]
			ctx.fillStyle = elements[enemy_element].color
			ctx.font = "16px Arial"
			ctx.fillText(species[enemy_species].symbol, object.x, object.y)

			if(object.health < species[enemy_species].health) {
				ratio = object.health/species[enemy_species].health
				ctx.fillStyle = "red"
				ctx.fillRect(object.x - 40, object.y - 30, 80*ratio, 8)
			}

			ctx.restore()
		}
		function drawInfo() {
			ctx.save()

			for(i=0; i<highestZone; i++) {
				ctx.strokeRect(10 + 90*i, 10, 75, 75)
				ctx.font = "14px Arial"
				ctx.fillText(species_tags[i], 25 + 90*i, 50)
				if(i == currentZone - 1) {
					ctx.fillText("Stage " + currentStage, 25 + 90*i, 70)
				}
			}
			ctx.fillText("Health " + Math.round(hero.health), 10, 100)
			ctx.fillStyle = "blue"
			ctx.fillText("Crystal " + crystal_store, 10, 120)
			ctx.fillStyle = "brown"
			ctx.fillText("Stone " + stone_store, 10, 140)
			ctx.fillStyle = "green"
			ctx.fillText("Leaf " + leaf_store, 10, 160)
			ctx.fillStyle = "black"
			ctx.fillText("Inventory", 10, 180)

			ctx.font = "10px Arial"
			if(messages.length > 0) {
				for(i=messages.length - 1; i>=0; i--) {
					ctx.fillText(messages[i], 500, 675-(messages.length-1-i)*10)
				}
				if(Date.now()/1000 > clear_messages) {
					messages.splice(0, messages.length)
				}
			}

			ctx.restore()
		}
		function drawInventory() {
			ctx.save()

			if (!inventory_loaded){
				ctx.clearRect(0, 0, 700, 700)
				ctx.font = "14px Arial"
				ctx.fillText("Close Inventory", 10, 10)

				clickables = {}
				clickables["close"] = {left: 8, top: 10, height: 14, width: 110, action: function() {
					clickables = {}
					for(i=1; i<=highestZone; i++){
						clickables["zone" + i] = { left: 10 + 90*(i-1), top: 10, height: 75, width: 75, action: function() {
							currentZone = i
							currentStage = 1
							hero.x = 350
							hero.y = 600
							enemies.splice(0, enemies.length)
							spawnEnemies()
						}}
					}
					showInventory = false
					inventory_loaded = false
					clickables["inventory"] = { left: 10, top: 180, height: 14, width: 65, action: function() {
						showInventory = true
					}}
				}}
				var inventory_tags = []
				for(item in inventory){
					inventory_tags.push(item)
					i = inventory_tags.length - 1
					var equipped_flag = ""
					item_stats = drops[item]
					if(item_stats == hero.weapon || item_stats == hero.helmet || item_stats == hero.torso || item_stats == hero.legs) {
						equipped_flag = " Equipped"
					}
					ctx.font = "16px Arial"
					if(item_stats.type == "sword" || item_stats.type == "bow" || item_stats.type == "magic") {
						ctx.fillText("Equip " + item + " Attack " + item_stats.attack + " Number " + inventory[item] + equipped_flag, 10, 50 + 20*i)
					} else {
						ctx.fillText("Equip " + item + " Defence " + item_stats.defence + " Number " + inventory[item] + equipped_flag, 10, 50 + 20*i)
					}
					ctx.moveTo(10, 55 + 20*i)
					ctx.lineTo(400, 55 + 20*i)
					ctx.lineWidth = 3
					ctx.stroke()
				}
				for(item in inventory) {
					i = inventory_tags.indexOf(item)
					clickables[item] = { left: 10, top: 46 + 20*i, height: 16, width: 50, action: function(item) {
						item_stats = drops[item]

						if(item_stats.type == "sword" || item_stats.type == "bow" || item_stats.type == "magic") {
							hero.weapon = item_stats
						} else {
							if(item_stats.type == "helmet") {
								hero.helmet = item_stats
							} else if(item_stats.type == "torso") {
								hero.torso = item_stats
							} else if(item_stats.type == "legs") {
								hero.legs = item_stats
							}
						}
						ctx.clearRect(0, 20, 700, 700)
						for(item in inventory){
							i = inventory_tags.indexOf(item)
							var equipped_flag = ""
							item_stats = drops[item]
							if(item_stats == hero.weapon || item_stats == hero.helmet || item_stats == hero.torso || item_stats == hero.legs) {
								equipped_flag = " Equipped"
							}
							ctx.font = "16px Arial"
							if(item_stats.type == "sword" || item_stats.type == "bow" || item_stats.type == "magic") {
								ctx.fillText("Equip " + item + " Attack " + item_stats.attack + " Number " + inventory[item] + equipped_flag, 10, 50 + 20*i)
							} else {
								ctx.fillText("Equip " + item + " Defence " + item_stats.defence + " Number " + inventory[item] + equipped_flag, 10, 50 + 20*i)
							}
						}
						ctx.moveTo(10, 55 + 20*i)
						ctx.lineTo(400, 55 + 20*i)
						ctx.lineWidth = 3
						ctx.stroke()
					}}
				}
				inventory_loaded = true
			}

			ctx.restore()
		}
		function drawBolt() {
			ctx.save()

			ctx.font = "16px Arial"
			symbol = ""
			if(hero.weapon.type == "bow"){
				ctx.fillStyle = "black"
				symbol = "|"
			} else {
				ctx.fillStyle = "red"
				symbol = "o"
			}
			if(Date.now()/1000 > hero.cooldown){
				ctx.fillText(symbol, bolt.x, bolt.y)
			}

			ctx.restore()
		}


		var ctx = this.canvas.getContext("2d")

		if(showInventory){
			drawInventory()
		} else {
			ctx.clearRect(0, 0, 700, 700)
			drawInfo()
			drawHero(hero)
			for(i=0; i<enemies.length; i++) {
				drawEnemy(enemies[i])
			}
			if(boltFired){
				drawBolt()
			}
		}
	}

	function update(time) {
		for(i=0; i<enemies.length; i++) {
			var xdif = hero.x - enemies[i].x
			var ydif = hero.y - enemies[i].y
			var dist = Math.sqrt(xdif*xdif + ydif*ydif)

			if(dist > 100) {
				enemies[i].trajectory.turning += (.5 - Math.random())/200
				if(Math.abs(enemies[i].trajectory.turning) > .02) {
					enemies[i].trajectory.turning = enemies[i].trajectory.turning/2
				}
				enemies[i].trajectory.angle += enemies[i].trajectory.turning

				if(enemies[i].x < 25) {
					enemies[i].x = 25
					enemies[i].trajectory.angle += Math.PI
				} else if(enemies[i].x > 675) {
					enemies[i].x = 675
					enemies[i].trajectory.angle += Math.PI
				}
				if(enemies[i].y < 25) {
					enemies[i].y = 25
					enemies[i].trajectory.angle += Math.PI
				} else if(enemies[i].y > 675) {
					enemies[i].y = 675
					enemies[i].trajectory.angle += Math.PI
				}

				enemies[i].x += 2*Math.cos(enemies[i].trajectory.angle)/10
				enemies[i].y += 2*Math.sin(enemies[i].trajectory.angle)/10
			} else {
				enemies[i].aggro = true
			}
			if(enemies[i].aggro){
				angle = Math.atan2(ydif, xdif)
				movex = Math.cos(angle)
				movey = Math.sin(angle)
				if(dist > 25) {
					enemies[i].x += movex
					enemies[i].y += movey
				} else {
					if(Date.now()/1000 > enemies[i].cooldown){
						damage = species[enemies[i].species].attack
						defence = hero.defence
						defence += hero.helmet ? hero.helmet.defence : 0
						defence += hero.torso ? hero.torso.defence : 0
						defence += hero.legs ? hero.legs.defence : 0
						damage = damage/defence
						hero.health -= damage
						enemies[i].cooldown = Date.now()/1000 + 1
					}

					if(hero.health <= 0) {
						currentStage = 1
						hero.health = 100
						hero.x = 350
						hero.y = 600

						enemies.splice(0, enemies.length)
						spawnEnemies()
					}
				}
			}
		}

		var closest_dist = 2000
		var closest_enemy = 0
		for(i=0; i<enemies.length; i++){
			xdif = Math.abs(enemies[i].x - hero.x)
			ydif = Math.abs(enemies[i].y - hero.y)
			dist = Math.sqrt(xdif*xdif + ydif*ydif)
			if(dist < closest_dist) {
				closest_dist = dist
				closest_enemy = i
			}
		}
		xdif = enemies[closest_enemy].x - hero.x
		ydif = enemies[closest_enemy].y - hero.y

		angle = Math.atan2(ydif, xdif)
		movex = hero.speed*Math.cos(angle)
		movey = hero.speed*Math.sin(angle)
		if (closest_dist > hero.weapon.range) {
			hero.x += movex
			hero.y += movey
		} else {
			if(Date.now()/1000 > hero.cooldown){
				if(boltFired == false && hero.weapon && (hero.weapon.type == "bow" || hero.weapon.type == "magic")) {
					boltFired = true
					bolt.x = hero.x
					bolt.y = hero.y
					bolt.targetid = closest_enemy
					hero.cooldown = Date.now()/1000 + hero.weapon.cooldown
				}
				if(hero.weapon.type == "sword"){
					damage = hero.attack + hero.weapon.attack
					damage = damage/species[enemies[closest_enemy].species].defence
					enemies[closest_enemy].health -= damage/10
					hero.cooldown = Date.now()/1000 + 1
				} else if(boltFired) {
					diffx = enemies[bolt.targetid].x - bolt.x
					diffy = enemies[bolt.targetid].y - bolt.y
					dist = Math.sqrt(diffx*diffx + diffy*diffy)

					if(dist < 15) {
						damage = hero.attack + hero.weapon.attack
						damage = damage/species[enemies[bolt.targetid].species].defence
						enemies[bolt.targetid].health -= damage/10
						enemies[bolt.targetid].aggro = true
						bolt.x = undefined
						bolt.y = undefined
						bolt.targetid = undefined
						boltFired = false
					}

					angle = Math.atan2(diffy, diffx)
					bolt.angle = angle
					bolt.x += 5*Math.cos(angle)
					bolt.y += 5*Math.sin(angle)
				}
			}
			if(enemies[closest_enemy].health <= 0) {
				if(enemies[closest_enemy].element == "crystal") {
					crystal_store += species[enemies[closest_enemy].species].reward
				} else if(enemies[closest_enemy].element == "stone") {
					stone_store += species[enemies[closest_enemy].species].reward
				} else if(enemies[closest_enemy].element == "leaf") {
					leaf_store += species[enemies[closest_enemy].species].reward
				}
				var droproll = 1000*Math.random()
				if(droproll < 25) {
					var roll = Math.floor(3*Math.random())
					if(roll == 0) {
						inventory["greatsword"] ? inventory["greatsword"] += 1 : inventory["greatsword"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a greatsword")
						clear_messages = Date.now()/1000 + 3
					} else if(roll == 1) {
						inventory["greatbow"] ? inventory["greatbow"] += 1 : inventory["greatbow"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a greatbow")
						clear_messages = Date.now()/1000 + 3
					} else {
						inventory["tome"] ? inventory["tome"] += 1 : inventory["tome"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a tome")
						clear_messages = Date.now()/1000 + 3
					}
				} else if(droproll < 50) {
					var roll = Math.floor(3*Math.random())
					if(roll == 0) {
						inventory["full helm"] ? inventory["full helm"] += 1 : inventory["full helm"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a full helm")
						clear_messages = Date.now()/1000 + 3
					} else if(roll == 1) {
						inventory["platebody"] ? inventory["platebody"] += 1 : inventory["platebody"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a platebody")
						clear_messages = Date.now()/1000 + 3
					} else {
						inventory["platelegs"] ? inventory["platelegs"] += 1 : inventory["platelegs"] = 1
						messages.push(enemies[closest_enemy].species + " dropped platelegs")
						clear_messages = Date.now()/1000 + 3
					}
				} else if(droproll < 100) {
					var roll = Math.floor(3*Math.random())
					if(roll == 0) {
						inventory["longsword"] ? inventory["longsword"] += 1 : inventory["longsword"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a longsword")
						clear_messages = Date.now()/1000 + 3
					} else if(roll == 1) {
						inventory["longbow"] ? inventory["longbow"] += 1 : inventory["longbow"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a longbow")
						clear_messages = Date.now()/1000 + 3
					} else {
						inventory["battlestaff"] ? inventory["battlestaff"] += 1 : inventory["battlestaff"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a battlestaff")
						clear_messages = Date.now()/1000 + 3
					}
				} else if(droproll < 150) {
					var roll = Math.floor(3*Math.random())
					if(roll == 0) {
						inventory["med helm"] ? inventory["med helm"] += 1 : inventory["med helm"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a med helm")
						clear_messages = Date.now()/1000 + 3
					} else if(roll == 1) {
						inventory["chain torso"] ? inventory["chain torso"] += 1 : inventory["chain torso"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a chain torso")
						clear_messages = Date.now()/1000 + 3
					} else {
						inventory["chainskirt"] ? inventory["chainskirt"] += 1 : inventory["chainskirt"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a chainskirt")
						clear_messages = Date.now()/1000 + 3
					}
				} else if(droproll < 250) {
					var roll = Math.floor(3*Math.random())
					if(roll == 0) {
						inventory["shortsword"] ? inventory["shortsword"] += 1 : inventory["shortsword"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a shortsword")
						clear_messages = Date.now()/1000 + 3
					} else if(roll == 1) {
						inventory["shortbow"] ? inventory["shortbow"] += 1 : inventory["shortbow"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a shortbow")
						clear_messages = Date.now()/1000 + 3
					} else {
						inventory["staff"] ? inventory["staff"] += 1 : inventory["staff"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a staff")
						clear_messages = Date.now()/1000 + 3
					}
					clear_messages = Date.now()/1000 + 3
				} else if(droproll < 350) {
					var roll = Math.floor(3*Math.random())
					if(roll == 0) {
						inventory["leather helm"] ? inventory["leather helm"] += 1 : inventory["leather helm"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a leather helm")
						clear_messages = Date.now()/1000 + 3
					} else if(roll == 1) {
						inventory["leather torso"] ? inventory["leather torso"] += 1 : inventory["leather torso"] = 1
						messages.push(enemies[closest_enemy].species + " dropped a leather torso")
						clear_messages = Date.now()/1000 + 3
					} else {
						inventory["leather chaps"] ? inventory["leather chaps"] += 1 : inventory["leather chaps"] = 1
						messages.push(enemies[closest_enemy].species + " dropped leather chaps")
						clear_messages = Date.now()/1000 + 3
					}
				}
				enemies.splice(closest_enemy, 1)

				if(enemies.length == 0) {
					currentStage += 1
					if(currentStage == 10) {
						highestZone += 1
						clickables["zone" + highestZone] = { left: 10 + 90*(highestZone-1), top: 10, height: 75, width: 75, action: function() {
							currentZone = highestZone
							currentStage = 1
							hero.x = 350
							hero.y = 600
							enemies.splice(0, enemies.length)
							spawnEnemies()
						}}
					}
					spawnEnemies()
					hero.x = 350
					hero.y = 600
				}
			}
		}
	}

	var now = Date.now(),
		delta = (now - then)/1000

	createCanvas()
	if(!showInventory){
		update(delta)
	}

	then = now

	window.requestAnimationFrame(main)
}

window.onload = function() {
	document.getElementById("cv").addEventListener("click", function(event) {
		var x = event.pageX,
			y = event.pageY
			for(tag in clickables) {
				if(x > clickables[tag].left && x < clickables[tag].left + clickables[tag].width
					&& y > clickables[tag].top && y < clickables[tag].top + clickables[tag].height) {
					clickables[tag].action(tag)
				}
			}
	})

	canvas = document.getElementById("cv");
	spawnEnemies()
	main();
}

</script>
	<canvas height="700px" width="700px" id="cv"></canvas>
</body>
